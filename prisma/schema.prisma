generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Contact {
  id           String    @id @default(cuid())
  phone        String    @unique
  firstName    String?
  lastName     String?
  email        String?
  tags         String    @default("")
  source       String    @default("manual") // manual, csv, keyword, popup
  optedOut     Boolean   @default(false)
  optedOutAt   DateTime?
  lastTextedAt DateTime?
  messageCount Int       @default(0)
  timezone     String    @default("America/Chicago")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  messages       SmsLog[]
  automationLogs AutomationLog[]
  clicks         Click[]
  orders         Order[]
}

model Campaign {
  id          String    @id @default(cuid())
  name        String
  content     String
  status      String    @default("draft") // draft, scheduled, sending, sent, failed
  scheduledAt DateTime?
  sentAt      DateTime?
  type        String    @default("sms") // sms, mms

  // Stats
  totalCount     Int   @default(0)
  sentCount      Int   @default(0)
  deliveredCount Int   @default(0)
  failedCount    Int   @default(0)
  clickedCount   Int   @default(0)
  revenue        Float @default(0)

  // Media (for MMS)
  mediaUrl String?

  // Relations
  segmentId String?
  segment   Segment? @relation(fields: [segmentId], references: [id])
  links     Link[]
  messages  SmsLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SmsLog {
  id            String    @id @default(cuid())
  campaignId    String
  contactId     String?
  phone         String
  message       String
  mediaUrl      String?
  messageType   String    @default("sms")
  status        String    @default("queued")
  providerMsgId String?
  error         String?
  sentAt        DateTime?
  deliveredAt   DateTime?
  createdAt     DateTime  @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id])
  contact  Contact? @relation(fields: [contactId], references: [id])
}

model MediaAsset {
  id        String   @id @default(cuid())
  filename  String
  url       String
  mimeType  String
  sizeBytes Int
  createdAt DateTime @default(now())
}

// ============================================
// SEGMENTATION
// ============================================

model Segment {
  id           String   @id @default(cuid())
  name         String
  description  String?
  filters      String // JSON: [{field, operator, value}]
  contactCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campaigns Campaign[]
}

// ============================================
// AUTOMATION
// ============================================

model Automation {
  id            String   @id @default(cuid())
  name          String
  trigger       String // new_contact, keyword, scheduled
  triggerConfig String? // JSON: {keyword, schedule, etc}
  isActive      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  steps AutomationStep[]
  logs  AutomationLog[]
}

model AutomationStep {
  id           String @id @default(cuid())
  automationId String
  order        Int
  type         String // send_sms, wait, condition
  config       String // JSON: {message, delayMinutes, etc}

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
}

model AutomationLog {
  id           String    @id @default(cuid())
  automationId String
  contactId    String
  stepId       String?
  status       String // triggered, in_progress, completed, failed
  nextStepAt   DateTime? // When to execute next step
  createdAt    DateTime  @default(now())

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  contact    Contact    @relation(fields: [contactId], references: [id])
}

// ============================================
// REVENUE ATTRIBUTION
// ============================================

model Link {
  id          String    @id @default(cuid())
  originalUrl String
  slug        String    @unique
  campaignId  String?
  campaign    Campaign? @relation(fields: [campaignId], references: [id])
  clicks      Click[]
  createdAt   DateTime  @default(now())
}

model Click {
  id        String   @id @default(cuid())
  linkId    String
  link      Link     @relation(fields: [linkId], references: [id])
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
}

model Order {
  id              String   @id @default(cuid())
  externalId      String   @unique // Store's order ID
  totalAmount     Float
  currency        String   @default("USD")
  contactId       String
  contact         Contact  @relation(fields: [contactId], references: [id])
  attributionType String? // "campaign" or "automation"
  attributedId    String? // Campaign ID or Automation ID
  createdAt       DateTime @default(now())
}
